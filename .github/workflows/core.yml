name: Core (Mirror Upstream Release)

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      post_telegram:
        description: 'Post to Telegram'
        required: true
        type: boolean

  schedule:
    - cron: "*/30 * * * *"   # every 30 min auto sync

  push:
    branches: [ master ]


jobs:
  mirror:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4


      # -----------------------------
      # Setup Python
      # -----------------------------
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install requests
        run: pip install requests


      # -----------------------------
      # Create mirror script
      # -----------------------------
      - name: Create mirror script
        run: |
          cat << 'EOF' > mirror.py
          import requests

          SOURCE = "https://api.github.com/repos/ThePedroo/ReLSPosed/releases/latest"

          print("Fetching latest release info...")
          data = requests.get(SOURCE).json()

          assets = data["assets"]

          release_asset = next(a for a in assets if "zygisk-release" in a["name"])
          debug_asset   = next(a for a in assets if "zygisk-debug" in a["name"])

          def download(url, filename):
              print("Downloading", filename)
              r = requests.get(url)
              open(filename, "wb").write(r.content)

          download(release_asset["browser_download_url"], release_asset["name"])
          download(debug_asset["browser_download_url"], debug_asset["name"])

          print("Done downloading files.")
          EOF


      # -----------------------------
      # Download upstream zips
      # -----------------------------
      - name: Download upstream release files
        run: python mirror.py


      # -----------------------------
      # Upload to YOUR release
      # -----------------------------
      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: Latest Build (mirror)
          files: "*.zip"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


      # -----------------------------
      # Optional Telegram post (kept from your old workflow)
      # -----------------------------
      - name: Post to channel
        if: ${{ success() && inputs.post_telegram != 'false' }}
        env:
          CHANNEL_ID: ${{ secrets.CHANNEL_ID }}
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
        run: |
          if [ ! -z "${BOT_TOKEN}" ]; then
            for f in *.zip; do
              curl -F document=@"$f" \
                "https://api.telegram.org/bot${BOT_TOKEN}/sendDocument?chat_id=${CHANNEL_ID}"
            done
          fi
